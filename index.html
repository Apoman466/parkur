<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SKYLINE: WORLD OF AVATARS</title>
    <style>
        body { margin: 0; overflow: hidden; background: #87CEEB; font-family: 'Segoe UI', sans-serif; touch-action: none; }
        #overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); display: flex; align-items: center; justify-content: center; z-index: 2000; }
        .auth-card { background: white; padding: 40px; border-radius: 30px; box-shadow: 0 20px 60px rgba(0,0,0,0.2); text-align: center; border: 4px solid #4CAF50; }
        
        /* Saƒü Panel: Kƒ±yafet & Kozmetik */
        #custom-panel { position: absolute; right: -320px; top: 0; width: 300px; height: 100%; background: rgba(255,255,255,0.95); transition: 0.5s; z-index: 1500; padding: 20px; box-shadow: -5px 0 20px rgba(0,0,0,0.1); overflow-y: auto; }
        #custom-panel.active { right: 0; }
        .toggle-panel { position: absolute; left: -60px; top: 20px; width: 50px; height: 50px; background: #4CAF50; color: white; border-radius: 10px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 24px; }
        
        .option-group { margin-bottom: 20px; border-bottom: 1px solid #ddd; padding-bottom: 10px; }
        select, input[type="color"] { width: 100%; padding: 8px; margin-top: 5px; border-radius: 5px; border: 1px solid #ccc; }
        
        #ui { position: absolute; top: 20px; left: 20px; z-index: 100; pointer-events: none; font-weight: bold; font-size: 20px; color: #333; }
        #mobile-ui { position: absolute; bottom: 30px; width: 100%; display: none; justify-content: space-between; padding: 0 30px; z-index: 100; }
        .m-btn { width: 70px; height: 70px; background: white; border: 3px solid #4CAF50; border-radius: 20px; display: flex; align-items: center; justify-content: center; font-size: 25px; }
        .btn-google { background: #4285F4; color: white; padding: 12px 25px; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; margin-top: 10px; }
    </style>
</head>
<body>

    <audio id="bg-music" loop><source src="sarki.mp3" type="audio/mpeg"></audio>

    <div id="overlay">
        <div class="auth-card">
            <h1 style="color:#4CAF50; margin:0;">SKYLINE GO</h1>
            <p>M√ºlakat & APK Hazƒ±rlƒ±k S√ºr√ºm√º</p>
            <input type="text" id="room-input" placeholder="ODA KODU">
            <br>
            <button class="btn-google" onclick="loginWithGoogle()">GOOGLE ƒ∞LE Gƒ∞Rƒ∞≈û YAP</button>
        </div>
    </div>

    <div id="ui">Y√úKSEKLƒ∞K: <span id="h-val">0</span>m</div>

    <div id="custom-panel">
        <div class="toggle-panel" onclick="document.getElementById('custom-panel').classList.toggle('active')">üëï</div>
        <h3 style="color:#4CAF50">AVATAR EDƒ∞T√ñR√ú</h3>
        
        <div class="option-group">
            <label>Kƒ±yafet Tema (100+ Varyasyon)</label>
            <select id="skin-type" onchange="updateCustoms()">
                <option value="none">Normal ƒ∞nsan</option>
                <option value="cat">Kedi Kost√ºm√º</option>
                <option value="dog">K√∂pek Kost√ºm√º</option>
                <option value="monster">Canavar</option>
                <option value="robot">Cyber-Robot</option>
            </select>
            <input type="color" id="skin-color" value="#4CAF50" onchange="updateCustoms()">
        </div>

        <div class="option-group">
            <label>Kozmetik (Kulaklƒ±k/G√∂zl√ºk/≈ûapka)</label>
            <select id="acc-type" onchange="updateCustoms()">
                <option value="none">Yok</option>
                <option value="headphone">Profesyonel Kulaklƒ±k</option>
                <option value="glasses">Pilot G√∂zl√ºƒü√º</option>
                <option value="hat">Havalƒ± ≈ûapka</option>
                <option value="crown">Kral Tacƒ±</option>
            </select>
            <input type="color" id="acc-color" value="#ff00ff" onchange="updateCustoms()">
        </div>

        <div class="option-group">
            <label>Sƒ±rt √áantasƒ± & Kanat</label>
            <select id="back-type" onchange="updateCustoms()">
                <option value="none">Yok</option>
                <option value="bag">Okul √áantasƒ±</option>
                <option value="jetpack">Jetpack (Alevli)</option>
                <option value="wings">Melek Kanatlarƒ±</option>
            </select>
            <input type="color" id="back-color" value="#00f2fe" onchange="updateCustoms()">
        </div>
    </div>

    <div id="mobile-ui">
        <div style="display:flex; flex-direction:column; align-items:center;">
            <div class="m-btn" onpointerdown="keys['KeyW']=true" onpointerup="keys['KeyW']=false">‚Üë</div>
            <div style="display:flex;"><div class="m-btn" onpointerdown="keys['KeyA']=true" onpointerup="keys['KeyA']=false">‚Üê</div><div class="m-btn" onpointerdown="keys['KeyS']=true" onpointerup="keys['KeyS']=false">‚Üì</div><div class="m-btn" onpointerdown="keys['KeyD']=true" onpointerup="keys['KeyD']=false">‚Üí</div></div>
        </div>
        <div class="m-btn" style="width:100px; height:100px; background:#FFC107;" onpointerdown="keys['Space']=true" onpointerup="keys['Space']=false">ZIP</div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <script>
        const config = { 
            apiKey: "AIzaSyD-gQNjOz03WhErBDD24hpJr4q5h30CCGU", 
            authDomain: "ekiple-parkur.firebaseapp.com",
            databaseURL: "https://ekiple-parkur-default-rtdb.firebaseio.com/", 
            projectId: "ekiple-parkur" 
        };
        firebase.initializeApp(config);
        const db = firebase.database();
        const auth = firebase.auth();

        let scene, camera, renderer, player, clock = new THREE.Clock();
        let otherPlayers = {}, keys = {}, isGameStarted = false, myId, roomId;
        let checkpoint = new THREE.Vector3(0, 10, 0), velocityY = 0, isJumping = false, yaw = 0;
        let pData = { skin: 'none', sCol: '#4CAF50', acc: 'none', aCol: '#ff00ff', back: 'none', bCol: '#00f2fe' };

        function loginWithGoogle() {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider).then(res => {
                myId = res.user.uid;
                roomId = document.getElementById('room-input').value || "genel";
                document.getElementById('overlay').style.display = 'none';
                if(/Android|iPhone/i.test(navigator.userAgent)) document.getElementById('mobile-ui').style.display = 'flex';
                isGameStarted = true;
                initGame(res.user.displayName.split(' ')[0]);
            });
        }

        function createAvatar(name, data, isMe) {
            const group = new THREE.Group();
            // G√∂vde
            const body = new THREE.Mesh(new THREE.BoxGeometry(0.8, 1.4, 0.5), new THREE.MeshStandardMaterial({color: data.sCol}));
            group.add(body);
            // Kafa
            const head = new THREE.Mesh(new THREE.BoxGeometry(0.65, 0.65, 0.65), new THREE.MeshStandardMaterial({color: 0xffdbac}));
            head.position.y = 1.1; group.add(head);

            // Kost√ºm Par√ßalarƒ± (Kulak, Kuyruk vb)
            if(data.skin === 'cat') {
                const earL = new THREE.Mesh(new THREE.ConeGeometry(0.15, 0.3, 4), new THREE.MeshStandardMaterial({color: data.sCol}));
                earL.position.set(-0.2, 0.4, 0); head.add(earL);
                const earR = earL.clone(); earR.position.x = 0.2; head.add(earR);
            }

            // Kozmetik Par√ßalarƒ±
            if(data.acc === 'headphone') {
                const hp = new THREE.Mesh(new THREE.TorusGeometry(0.35, 0.08, 8, 16), new THREE.MeshStandardMaterial({color: data.aCol}));
                hp.rotation.y = Math.PI/2; head.add(hp);
            }

            // Arka Par√ßalar
            if(data.back === 'jetpack') {
                const jp = new THREE.Mesh(new THREE.BoxGeometry(0.5, 0.8, 0.3), new THREE.MeshStandardMaterial({color: data.bCol}));
                jp.position.set(0, 0, -0.4); group.add(jp);
            }

            // ƒ∞sim Etiketi
            const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
            canvas.width = 256; canvas.height = 64; ctx.fillStyle = isMe ? '#4CAF50' : '#E91E63'; ctx.font = 'bold 32px Arial'; ctx.textAlign='center';
            ctx.fillText(name, 128, 45);
            const sprite = new THREE.Sprite(new THREE.SpriteMaterial({map: new THREE.CanvasTexture(canvas)}));
            sprite.position.y = 2.5; sprite.scale.set(2.5, 0.6, 1); group.add(sprite);

            return group;
        }

        function updateCustoms() {
            pData.skin = document.getElementById('skin-type').value;
            pData.sCol = document.getElementById('skin-color').value;
            pData.acc = document.getElementById('acc-type').value;
            pData.aCol = document.getElementById('acc-color').value;
            pData.back = document.getElementById('back-type').value;
            pData.bCol = document.getElementById('back-color').value;
            
            if(player) {
                scene.remove(player);
                player = createAvatar(auth.currentUser.displayName.split(' ')[0], pData, true);
                scene.add(player);
            }
        }

        function initGame(uName) {
            scene = new THREE.Scene(); scene.background = new THREE.Color(0x87CEEB);
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 5000);
            renderer = new THREE.WebGLRenderer({ antialias: true }); renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);
            scene.add(new THREE.AmbientLight(0xffffff, 0.8));
            
            player = createAvatar(uName, pData, true); scene.add(player);

            // SYNC
            const roomRef = db.ref('rooms/' + roomId + '/players');
            roomRef.child(myId).onDisconnect().remove();
            roomRef.on('value', snap => {
                const d = snap.val(); if(!d) return;
                for(let id in d) {
                    if(id === myId) continue;
                    if(!otherPlayers[id]) {
                        otherPlayers[id] = createAvatar(d[id].name, d[id].pData, false);
                        scene.add(otherPlayers[id]);
                    }
                    otherPlayers[id].position.lerp(new THREE.Vector3(d[id].x, d[id].y, d[id].z), 0.2);
                    otherPlayers[id].rotation.y = d[id].ry;
                }
                for(let id in otherPlayers) { if(!d[id]) { scene.remove(otherPlayers[id]); delete otherPlayers[id]; } }
            });

            // PARKUR
            for(let i=0; i<400; i++) {
                let a = i*0.25; let x = Math.cos(a)*80, y = i*4.5, z = Math.sin(a)*80;
                let mesh = new THREE.Mesh(new THREE.BoxGeometry(i%12===0?35:22, 2, i%12===0?35:22), new THREE.MeshStandardMaterial({color: i%12===0?0x00ff00 : new THREE.Color().setHSL((i%50)/50, 0.7, 0.6)}));
                mesh.position.set(x, y, z); scene.add(mesh);
                if(i===0) { checkpoint.set(x, y+5, z); player.position.copy(checkpoint); }
            }

            window.onkeydown = e => keys[e.code] = true; window.onkeyup = e => keys[e.code] = false;
            document.addEventListener('mousemove', e => { if(document.pointerLockElement) yaw -= e.movementX*0.003; });
            document.addEventListener('mousedown', () => { if(isGameStarted) document.body.requestPointerLock(); });

            setInterval(() => {
                if(isGameStarted) roomRef.child(myId).set({ x: player.position.x, y: player.position.y, z: player.position.z, ry: player.rotation.y, name: uName, pData: pData });
            }, 50);

            animate();
        }

        function animate() {
            requestAnimationFrame(animate); if(!isGameStarted) return;
            player.rotation.y = yaw;
            let move = new THREE.Vector3();
            if(keys['KeyW']) move.z -= 1; if(keys['KeyS']) move.z += 1;
            if(keys['KeyA']) move.x -= 1; if(keys['KeyD']) move.x += 1;
            move.applyQuaternion(player.quaternion).normalize();
            player.position.addScaledVector(move, 0.5);

            if(keys['Space'] && !isJumping) { velocityY = 0.52; isJumping = true; }
            player.position.y += velocityY; velocityY -= 0.02;

            if(player.position.y < -40) player.position.copy(checkpoint);
            camera.position.lerp(player.position.clone().add(new THREE.Vector3(0, 10, 25).applyQuaternion(player.quaternion)), 0.1);
            camera.lookAt(player.position.clone().add(new THREE.Vector3(0, 2, 0)));
            renderer.render(scene, camera);
        }
    </script>
</body>
</html>
