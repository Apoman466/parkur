<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SKYLINE: Survivor Multi</title>
    <style>
        body { margin: 0; overflow: hidden; background: #87CEEB; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; touch-action: none; }
        #overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; text-align: center; }
        .menu-box { background: white; padding: 40px; border-radius: 25px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); border: 4px solid #4CAF50; }
        #ui { position: absolute; top: 20px; left: 20px; color: #333; z-index: 50; pointer-events: none; font-weight: bold; font-size: 18px; text-shadow: 1px 1px 0px white; }
        #mobile-ui { position: absolute; bottom: 30px; width: 100%; display: none; justify-content: space-between; padding: 0 30px; box-sizing: border-box; z-index: 150; pointer-events: none; }
        .m-btn { width: 65px; height: 65px; background: rgba(255,255,255,0.9); border: 2px solid #4CAF50; border-radius: 15px; display: flex; align-items: center; justify-content: center; font-size: 22px; color: #4CAF50; margin: 4px; pointer-events: auto; user-select: none; }
        .btn-start { padding: 15px 45px; font-size: 20px; cursor: pointer; border-radius: 50px; background: #4CAF50; color: white; border: none; font-weight: bold; margin-top: 15px; box-shadow: 0 6px 0 #2E7D32; }
        .btn-start:active { transform: translateY(4px); box-shadow: 0 2px 0 #2E7D32; }
        input { padding: 12px; border-radius: 10px; border: 2px solid #ddd; width: 220px; margin: 8px; text-align: center; font-size: 16px; }
        #connection-status { color: red; font-size: 12px; margin-top: 10px; display: none; }
    </style>
</head>
<body>

    <audio id="bg-music" loop><source src="sarki.mp3" type="audio/mpeg"></audio>

    <div id="overlay">
        <div class="menu-box">
            <h1 style="color:#4CAF50; margin:0; font-size: 35px;">SKYLINE üöÄ</h1>
            <p style="color:#666;">M√ºlakat & Multiplayer √ñzel</p>
            <input type="text" id="username" placeholder="Pƒ∞LOT ADI">
            <input type="text" id="room-input" placeholder="ODA KODU (Aynƒ± kodu girin)">
            <br>
            <button class="btn-start" onclick="loginAndStart()">Sƒ∞STEME Gƒ∞R</button>
            <div id="connection-status">Veritabanƒ±na baƒülanƒ±lamƒ±yor! L√ºtfen Rules'ƒ± kontrol et.</div>
        </div>
    </div>

    <div id="ui">
        Y√úKSEKLƒ∞K: <span id="h-val" style="color:#e91e63;">0</span>m | 
        ODA: <span id="room-id" style="color:#4CAF50;">-</span>
    </div>

    <div id="mobile-ui">
        <div style="display: flex; flex-direction: column; align-items: center;">
            <div class="m-btn" onpointerdown="keys['KeyW']=true" onpointerup="keys['KeyW']=false">‚Üë</div>
            <div style="display:flex;">
                <div class="m-btn" onpointerdown="keys['KeyA']=true" onpointerup="keys['KeyA']=false">‚Üê</div>
                <div class="m-btn" onpointerdown="keys['KeyS']=true" onpointerup="keys['KeyS']=false">‚Üì</div>
                <div class="m-btn" onpointerdown="keys['KeyD']=true" onpointerup="keys['KeyD']=false">‚Üí</div>
            </div>
        </div>
        <div style="display: flex; align-items: center;">
            <div class="m-btn" style="width:90px; height:90px; background:#FFC107; color:white; border:none;" onpointerdown="keys['Space']=true" onpointerup="keys['Space']=false">ZIPLA</div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <script>
        // --- SENƒ∞N G√úNCEL FIREBASE Bƒ∞LGƒ∞LERƒ∞N ---
        const firebaseConfig = { 
            apiKey: "AIzaSyD-gQNjOz03WhErBDD24hpJr4q5h30CCGU", 
            databaseURL: "https://ekiple-parkur-default-rtdb.firebaseio.com/", 
            projectId: "ekiple-parkur" 
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // Baƒülantƒ± Kontrol√º
        db.ref(".info/connected").on("value", (snap) => {
            document.getElementById('connection-status').style.display = snap.val() ? 'none' : 'block';
        });

        let scene, camera, renderer, player, clock = new THREE.Clock();
        let platforms = [], otherPlayers = {}, keys = {};
        let velocityY = 0, isJumping = false, yaw = 0;
        let checkpoint = new THREE.Vector3(0, 10, 0);
        let myId = "P-" + Math.random().toString(36).substr(2, 4);
        let isGameStarted = false, roomId;
        let touchX = 0, isTouching = false;

        function createPlayer(name, color) {
            const group = new THREE.Group();
            const body = new THREE.Mesh(new THREE.BoxGeometry(0.8, 1.4, 0.5), new THREE.MeshStandardMaterial({color: color}));
            const head = new THREE.Mesh(new THREE.BoxGeometry(0.6, 0.6, 0.6), new THREE.MeshStandardMaterial({color: 0xffdbac}));
            head.position.y = 1.1;
            group.add(body, head);
            
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 256; canvas.height = 64;
            ctx.fillStyle = 'black'; ctx.font = 'bold 32px Arial'; ctx.textAlign = 'center';
            ctx.fillText(name, 128, 45);
            const sprite = new THREE.Sprite(new THREE.SpriteMaterial({map: new THREE.CanvasTexture(canvas)}));
            sprite.position.y = 2.5; sprite.scale.set(3, 0.75, 1);
            group.add(sprite);
            return group;
        }

        function loginAndStart() {
            roomId = document.getElementById('room-input').value.trim() || "lobi";
            document.getElementById('room-id').innerText = roomId;
            document.getElementById('overlay').style.display = 'none';
            if(/Android|iPhone/i.test(navigator.userAgent)) document.getElementById('mobile-ui').style.display = 'flex';
            document.getElementById('bg-music').play().catch(()=>{});
            isGameStarted = true;
            initGame(document.getElementById('username').value || "Pilot");
        }

        function initGame(uName) {
            scene = new THREE.Scene(); scene.background = new THREE.Color(0x87CEEB);
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 5000);
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);
            
            scene.add(new THREE.AmbientLight(0xffffff, 0.7));
            const light = new THREE.DirectionalLight(0xffffff, 0.6); light.position.set(10, 20, 10); scene.add(light);

            player = createPlayer(uName, 0x4CAF50); scene.add(player);

            // MULTIPLAYER SYNC
            const roomRef = db.ref('rooms/' + roomId);
            roomRef.child(myId).onDisconnect().remove();

            roomRef.on('value', snap => {
                const data = snap.val();
                if(!data) return;
                for(let id in data) {
                    if(id === myId) continue;
                    if(!otherPlayers[id]) {
                        otherPlayers[id] = createPlayer(data[id].name, 0xe91e63);
                        scene.add(otherPlayers[id]);
                    }
                    otherPlayers[id].position.lerp(new THREE.Vector3(data[id].x, data[id].y, data[id].z), 0.2);
                    otherPlayers[id].rotation.y = data[id].ry;
                }
                for(let id in otherPlayers) { if(!data[id]) { scene.remove(otherPlayers[id]); delete otherPlayers[id]; } }
            });

            // PARKUR VE ENGELLER
            const types = ['normal','speed','jump','vanish','moving','spike'];
            for(let i = 0; i < 500; i++) {
                let a = i * 0.25; 
                let x = Math.cos(a)*80, y = i*4.5, z = Math.sin(a)*80;
                let isCP = (i % 12 === 0);
                if(i===0) { checkpoint.set(x, y+5, z); player.position.copy(checkpoint); }
                createPlatform(x, y, z, isCP ? 'checkpoint' : types[Math.floor(Math.random()*types.length)], i);
            }

            // KONTROLLER
            window.onkeydown = e => keys[e.code] = true;
            window.onkeyup = e => keys[e.code] = false;
            document.addEventListener('mousedown', () => { if(isGameStarted) document.body.requestPointerLock(); });
            document.addEventListener('mousemove', e => { if(document.pointerLockElement) yaw -= e.movementX * 0.003; });
            
            window.addEventListener('touchstart', e => { if(e.touches[0].clientX > window.innerWidth/2) { isTouching=true; touchX=e.touches[0].clientX; } });
            window.addEventListener('touchmove', e => { if(isTouching){ yaw -= (e.touches[0].clientX - touchX)*0.01; touchX=e.touches[0].clientX; } });
            window.addEventListener('touchend', () => isTouching=false);

            setInterval(() => {
                if(isGameStarted) roomRef.child(myId).set({ x: player.position.x, y: player.position.y, z: player.position.z, ry: player.rotation.y, name: uName });
            }, 50);

            animate();
        }

        function createPlatform(x, y, z, t, i) {
            let color = new THREE.Color().setHSL((i%60)/60, 0.7, 0.6);
            if(t==='checkpoint') color = 0x00FF00;
            const mesh = new THREE.Mesh(new THREE.BoxGeometry(t==='checkpoint'?35:24, 2, t==='checkpoint'?35:24), new THREE.MeshStandardMaterial({color: color}));
            mesh.position.set(x, y, z); scene.add(mesh);
            if(t==='spike') {
                const s = new THREE.Mesh(new THREE.ConeGeometry(1.2, 2.5, 8), new THREE.MeshStandardMaterial({color: 0xff0000}));
                s.position.set(0, 1.8, 0); mesh.add(s);
            }
            platforms.push({mesh, type: t, ox: x, oy: y, oz: z});
        }

        function animate() {
            requestAnimationFrame(animate);
            if(!isGameStarted) return;
            player.rotation.y = yaw;
            let dir = new THREE.Vector3();
            if(keys['KeyW']) dir.z -= 1; if(keys['KeyS']) dir.z += 1;
            if(keys['KeyA']) dir.x -= 1; if(keys['KeyD']) dir.x += 1;
            dir.applyQuaternion(player.quaternion).normalize();
            player.position.addScaledVector(dir, 0.48);

            if(keys['Space'] && !isJumping) { velocityY = 0.52; isJumping = true; }
            player.position.y += velocityY; velocityY -= 0.022;

            platforms.forEach(p => {
                const b = new THREE.Box3().setFromObject(p.mesh);
                if(new THREE.Box3().setFromCenterAndSize(player.position, new THREE.Vector3(1.2, 4, 1.2)).intersectsBox(b)) {
                    if(velocityY <= 0 && player.position.y > p.mesh.position.y) {
                        player.position.y = p.mesh.position.y + 3; velocityY = 0; isJumping = false;
                        if(p.type==='checkpoint' && checkpoint.y < p.mesh.position.y) checkpoint.set(p.mesh.position.x, p.mesh.position.y+5, p.mesh.position.z);
                    }
                    if(p.type==='speed') player.position.addScaledVector(dir, 0.7);
                    if(p.type==='jump') { velocityY = 0.85; isJumping = true; }
                    if(p.type==='vanish') setTimeout(() => p.mesh.visible = false, 500);
                    if(p.type==='spike' && player.position.y < p.mesh.position.y + 3) player.position.copy(checkpoint);
                }
                if(p.type==='moving') p.mesh.position.x = p.ox + Math.sin(Date.now()*0.0015)*20;
            });

            if(player.position.y < -50) player.position.copy(checkpoint);
            camera.position.lerp(player.position.clone().add(new THREE.Vector3(0, 12, 28).applyQuaternion(player.quaternion)), 0.1);
            camera.lookAt(player.position.clone().add(new THREE.Vector3(0, 3, 0)));
            document.getElementById('h-val').innerText = Math.floor(player.position.y);
            renderer.render(scene, camera);
        }
    </script>
</body>
</html>
